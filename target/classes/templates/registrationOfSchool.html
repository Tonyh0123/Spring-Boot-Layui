<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head th:include="layout :: htmlhead" th:with="title='大学生创业服务平台'">
    <link rel="stylesheet" href="/css/index.css"></link>
<body>
<!-- nav部分 -->
<div class="nav index">
    <div th:include="nav :: copyNav"></div>
</div>
<div class="layui-container" style="top: 200px">
<div class="layui-row"  style="position:absolute; top:30%; left:50%; margin:-199px 0 0 -30px;"> <!--  style="position:absolute; top:30%; left:47%; margin:-120px 0 0 -30px;"  -->
    <h1 style="text-align: center">院校申请使用</h1>
</div>
<div class="layui-row"  > <!--  style="position:absolute; top:42%; left:50%; margin:-170px 0 0 -150px;"  -->
    <form id="userForm" class="layui-form layui-form-pane" method="post" action="" >


        <div id="school" class="layui-row layui-form-item" >
            <div class="layui-col-xs6">
                <label class="layui-form-label">城市</label>
                <div class="layui-input-block " >
                    <select name="" id="cityName" lay-filter="mymymy" lay-verify="required" lay-search>
                    </select>
                </div>
            </div>

            <div class="layui-col-xs6">
                <label class="layui-form-label">学校</label>
                <div class="layui-input-block" >
                    <select name="schoolName" id="schoolName" lay-verify="required" lay-search>
                    </select>
                </div>
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">管理机构</label>
            <div class="layui-input-block">
                <input type="text" id="schoolManagerJob" name="schoolManagerJob" lay-verify="required" placeholder="请输入所属管理机构" autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-row layui-form-item">
            <div class=" layui-col-xs6" >
                <label class="layui-form-label">学校证明</label>
                <div class="layui-input-block">
                    <input type="text" id="jobConfirm" name="jobConfirm" lay-verify="required"  placeholder="请上传带学校办公室公章的证明文件照片，文件大小不超过80kb" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>

            <div class=" layui-col-xs6" >
                <button type="button" class="layui-btn" id="uploadButton1">
                    <i class="layui-icon">&#xe67c;</i>上传图片
                </button>

                <button type="button" class="layui-btn" id="previewButton1" style="display: none" onclick="picPreview1()">
                    <i class="layui-icon">&#xe67c;</i>预览图片
                </button>
            </div>
        </div>

        <div class="layui-row layui-form-item">
            <div class=" layui-col-xs6" >
                <label class="layui-form-label">身份证明</label>
                <div class="layui-input-block">
                    <input type="text" id="schoolConfirm" name="schoolConfirm" lay-verify="required"  placeholder="可上传在职工作证照片或其他证明文件照片，文件大小不超过80kb" autocomplete="off" class="layui-input" readonly>
                </div>
            </div>

            <div class=" layui-col-xs6" >
                <button type="button" class="layui-btn" id="uploadButton2">
                    <i class="layui-icon">&#xe67c;</i>上传图片
                </button>

                <button type="button" class="layui-btn" id="previewButton2" style="display: none" onclick="picPreview2()">
                    <i class="layui-icon">&#xe67c;</i>预览图片
                </button>
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input type="text" id="schoolManagerName" name="schoolManagerName" lay-verify="required" lay-reqtext="姓名是必填项，岂能为空？" placeholder="请输入真实姓名" autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item" >
            <label class="layui-form-label">手机</label>
            <div class="layui-input-block">
                <input type="text" id="schoolManagerPhone" name="schoolManagerPhone" lay-verify="phone"  placeholder="请输入手机号" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-row layui-form-item">
            <div class="layui-col-xs6" >
                <label class="layui-form-label">邮箱</label>
                <div class="layui-input-block">
                    <input type="text" id="schoolManagerEmail" name="schoolManagerEmail" lay-verify="email"  placeholder="请输入邮箱" autocomplete="off" class="layui-input">
                </div>
            </div>

            <div class="layui-col-xs6" >
                <label class="layui-form-label"><button type="button" class="layui-btn-xs layui-btn layui-btn-primary" onclick="createVerifyCode()"><b>获取验证码</b></button></label>
                <div class="layui-input-block">
                    <input type="text" id="verifyCode" name="" lay-verify="verifyCode"  placeholder="请输入验证码" autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-form-item" style="text-align: center;">
            <div class="layui-input-block" style="margin: 0 auto;">
                <button type="submit" class="layui-btn" lay-submit="" lay-filter="mysubmit">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
    <div id="loading" style="position: absolute; margin-left: 46%;margin-top: -15%; display: none">
        <img src="../images/loading.gif">
    </div>
</div>
</div>
<script src="/static/js/dateUtils.js"></script>
<script src="/static/js/sysUser/userList.js"></script>
<script src="/static/js/verifyCode.js"></script>
<script src="/js/MyVerifyJS.js"></script>
<script src="/js/publicJs.js"></script>
<script>
    var sended = false;
    var verifyed = false;
    var MainVerifyCode; //邮件验证码
    layui.use(['form', 'layedit', 'laydate','layer'], function(){
        var form = layui.form
            ,layer = layui.layer

        //监听提交整体表单
        form.on('submit(mysubmit)', function(data){
            if(sended == true && verifyed == true){
                $.ajax({
                    type: "POST",
                    data: $("#userForm").serialize(),
                    url: "/user/regSchoolUser",
                    success: function (data) {
                        if (data.code == 1) {
                            layer.alert(data.msg,function(){
                                window.location.href="/login";
                            });
                        } else {
                            layer.msg(data.msg,{icon:5,time:2000});
                        }
                    }
                });
            }else{

            }

            return false;
        });

    });

    //创建验证码，四位数字
    function createVerifyCode() {
        var email = document.getElementById("schoolManagerEmail").value;
        if(null != email && email!="" && new RegExp("^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\\.[a-zA-Z0-9-]+)*\\.[a-zA-Z0-9]{2,6}$").test(email)){
            console.log(email);
            var verifyCode = "";
            for (var i=0; i<4; i++){
                var randomNum = Math.floor(Math.random()*10);
                verifyCode = verifyCode + randomNum;

            }
            sendCode(verifyCode,email);
            sended = true;
        }else {
            layer.msg('请输入邮箱/邮箱格式不正确', {
                time: 3000, //3s后自动关闭
                icon: 2
            });
        }

    }

    //ajax请求后端发送邮件
    function sendCode(verifyCode,email) {
        document.getElementById("loading").style.display = "";
        $.ajax({
            type: "POST",
            dataType : 'json',
            data: {"verifyCode": verifyCode, "email": email},
            url: "/verifyCode/checkVerifyCode",
            success: function (data) {
                document.getElementById("loading").style.display = "none";
                if (data.code == 1) {
                    MainVerifyCode = verifyCode; //发送成功进行验证
                    layer.msg(data.msg,{icon:1,time:2000});
                } else {
                    document.getElementById("loading").style.display = "none";
                    layer.msg(data.msg,{icon:5,time:2000});
                }
            }
        })
    }
</script>
<script>
    var city = ["福州市","龙岩市","南平市","宁德市","莆田市","泉州市","三明市","厦门市","漳州市"];

    var fuzhou = ["福州大学","福建工程学院","福建农林大学","福建医科大学","福建中医药大学","福建师范大学","福建师范大学福清分校","闽江学院","福建船政交通职业学院",
        "福建商学院","福建警察学院","福建华南女子职业学院","福州职业技术学院","福建信息职业技术学院","福建农业职业技术学院","福建卫生职业技术学院","福州英华职业学院","福建农林大学东方学院","阳光学院",
        "福州大学至诚学院","福建师范大学协和学院","福建警官职业学院","福州外语外贸学院","福建江夏学院","福州黎明职业技术学院","福州科技职业技术学院","福建对外经济贸易 职业技术学院","福州理工学院",
        "福建生物工程职业技术学院","福建艺术职业学院","福建幼儿师范高等专科学校","福州软件职业技术学院","福建农林大学金山学院","福建体育职业技术学院","闽江师范高等专科学校","福州墨尔本理工职业学院"];
    var longyan = ["龙岩学院","闽西职业技术学院"];
    var nanping = ["武夷学院","福建林业职业技术学院","闽北职业技术学院","武夷山职业学院"];
    var ningde = ["宁德师范学院","宁德职业技术学院"];
    var putian = ["莆田学院","湄洲湾职业技术学院"];
    var quanzhou = ["华侨大学","泉州师范学院","黎明职业大学","仰恩大学","福建电力职业技术学院","泉州医学高等专科学校","闽南理工学院","泉州纺织服装职业学院"
        ,"泉州华光职业学院","泉州理工职业学院","福建师范大学闽南科技学院","泉州信息工程学院","泉州经贸职业技术学院","泉州工艺美术职业学院","泉州海洋职业学院","泉州轻工职业学院"
        ,"泉州幼儿师范高等专科学校","泉州工程职业技术学院"];
    var sanming = ["三明学院","福建水利电力职业技术学院","三明医学科技职业学院"];
    var xiamen = ["厦门大学","集美大学","厦门理工学院","厦门海洋职业技术学院","厦门医学院","厦门华厦学院","厦门工学院","集美大学诚毅学院"
        ,"厦门演艺职业学院","厦门华天涉外职业技术学院","厦门城市职业学院","厦门兴才职业技术学院","厦门软件职业技术学院","厦门南洋职业学院","厦门东海职业技术学院","厦门安防科技职业学院"];
    var zhangzhou = ["闽南师范大学","漳州职业技术学院","厦门大学嘉庚学院","漳州城市职业学院","漳州科技职业学院","漳州理工职业学院","漳州卫生职业学院"];


    $(function () {
        layui.use('form', function () {
            form = layui.form;

            //各种基于事件的操作，下面会有进一步介绍
            //设置省份数据
            setMyCity();
            //监听下拉事件
            form.on('select(mymymy)', function (data) {
                console.log(data.value);
                setSchool(data.value);

            });
        });

    });

    //设置城市数据
    function setMyCity() {
        //给城市下拉列表赋值

        var $cityName = $("#cityName");

        var modelVal = "";

        var option = $("<option value=''>" + "请选择城市" + "</option>");
        $cityName.append(option);
        //获取对应城市数据
        for (var i = 0, len = city.length; i < len; i++) {
            modelVal = city[i];
            var option = $("<option value='" + city[i] + "'>" + city[i] + "</option>");

            //添加到 select 元素中
            $cityName.append(option);
        }
        form.render('select');
        // setSchool($($cityName.get(0)).val());

    }

    //根据选中的城市获取对应的学校
    function setSchool(city) {
        var $school = $("#schoolName");
        var proCity, option, modelVal;
        if (city === "福州市") {
            proCity = fuzhou;
        }else if(city === "龙岩市"){
            proCity = longyan;
        }else if(city === "南平市"){
            proCity = nanping;
        }else if(city === "宁德市"){
            proCity = ningde;
        }else if(city === "莆田市"){
            proCity = putian;
        }else if(city === "泉州市"){
            proCity = quanzhou;
        }else if(city === "三明市"){
            proCity = sanming;
        }else if(city === "厦门市"){
            proCity = xiamen;
        }else if(city === "漳州市"){
            proCity = zhangzhou;
        }
        //先清空之前绑定的值
        $school.empty();


        var option = $("<option value=''>" + "请选择学校" + "</option>");
        $school.append(option);
        //设置对应省份的城市
        for (var i = 0, len = proCity.length; i < len; i++) {
            modelVal = proCity[i];
            option = "<option value='" + modelVal + "'>" + modelVal + "</option>";

            //添加
            $school.append(option);
        }
        form.render('select');
    }


</script>
<script>

    var pdf1 = "";
    var pdf2 = "";
    var realPdf1 = "";
    var realPdf2 = "";
    layui.use('upload', function(){
        var upload = layui.upload;
        //执行实例
        upload.render({
            elem: '#uploadButton1' //绑定元素
            ,url: '/upload/identifyConfirmFileUpload' //上传接口
            ,method: 'post'
            ,size: 80
            ,before:function () {
                document.getElementById("loading").style.display = "";
            }
            ,done: function(res){
                document.getElementById("loading").style.display = "none";
                document.getElementById("previewButton1").style.display='';
                pdf1 = res.fileUrl;
                realPdf1 = pdf1.replace("/identifyConfirmFile","F:/identifyConfirmFile");
                $("#jobConfirm").val(res.fileUrl);

            }
            ,error: function(){
                alert("failed");
                //请求异常回调
            }
        });

        upload.render({
            elem: '#uploadButton2' //绑定元素
            ,url: '/upload/identifyConfirmFileUpload' //上传接口
            ,method: 'post'
            ,size: 80
            ,before:function () {
                document.getElementById("loading").style.display = "";
            }
            ,done: function(res){
                document.getElementById("loading").style.display = "none";
                document.getElementById("previewButton2").style.display='';
                pdf2 = res.fileUrl;
                realPdf2 = pdf2.replace("/identifyConfirmFile","F:/identifyConfirmFile");
                $("#schoolConfirm").val(res.fileUrl);

            }
            ,error: function(){
                alert("failed");
                //请求异常回调
            }
        });
    });
    function picPreview1() {
        document.getElementById("loading").style.display = "";
        $.ajax({
            type: "POST",
            data: {"encFile":realPdf1},
            url: "/upload/decFile",
            async: true,
            success: function (res) {
                document.getElementById("loading").style.display = "none";
                var uul = res.fileurl;
                layui.use('layer', function () {
                    var layer = layui.layer;
                    layer.open({
                        title: '证明信息',
                        type: 2,
                        area: ['1000px', '950px'],
                        fixed: false, //不固定
                        maxmin: true,
                        content: uul,
                        end: function () {
                            var realDecFile = uul.replace("/identifyConfirmFile","F:/identifyConfirmFile");
                            $.ajax({
                                type: "POST",
                                data: {"decFile":realDecFile},
                                url: "/upload/encFile",
                                async: true,
                            });

                        }
                        //
                    });
                });
            },

        });
    }
    function picPreview2() {
        document.getElementById("loading").style.display = "";
        $.ajax({
            type: "POST",
            data: {"encFile":realPdf2},
            url: "/upload/decFile",
            async: true,
            success: function (res) {
                document.getElementById("loading").style.display = "none";
                var uul = res.fileurl;
                layui.use('layer', function () {
                    var layer = layui.layer;
                    layer.open({
                        title: '证明信息',
                        type: 2,
                        area: ['1000px', '950px'],
                        fixed: false, //不固定
                        maxmin: true,
                        content: uul,
                        end: function () {
                            var realDecFile = uul.replace("/identifyConfirmFile","F:/identifyConfirmFile");
                            $.ajax({
                                type: "POST",
                                data: {"decFile":realDecFile},
                                url: "/upload/encFile",
                                async: true,
                            });

                        }
                        //
                    });
                });
            },

        });
    }
</script>

</body>
</html>